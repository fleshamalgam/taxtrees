<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FEIS Notepad Editor</title>
  <style>
    body {
      margin: 0;
      font-family: "Courier New", Courier, monospace;
      background-color: white;
      color: black;
    }
    .toolbar {
      background-color: #336633;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }
    #editor {
      width: 100%;
      height: calc(100vh - 50px);
      padding: 20px;
      white-space: pre;
      overflow: auto;
      font-family: "Courier New", Courier, monospace;
      font-size: 14px;
      line-height: 1.2;
      outline: none;
    }
    button {
      font-family: monospace;
      font-size: 14px;
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="toolbar">
    FEIS Editor
    <button onclick="saveContent()">üíæ Save to Public Site</button>
  </div>

  <pre id="editor" contenteditable="true" spellcheck="false">
ABBREVIATION :
EQUARV

SYNONYMS :
  Equisetum arvense var. alpestre Wahlenb.
  E. a. var. boreale (Bong.) Rupr.
  E. a. var. riparium Farw.
  E. calderi Boivin
  </pre>

  <script>
    async function saveContent() {
      const content = document.getElementById("editor").innerText;
      const token = prompt("Enter your GitHub Personal Access Token:");

      if (!token) {
        alert("‚ùå No token entered.");
        return;
      }

      const repo = "fleshamalgam/taxtrees";
      const filePath = "index.html";
      const branch = "main";
      const apiUrl = `https://api.github.com/repos/${repo}/contents/${filePath}`;
      const headers = {
        "Authorization": `token ${token}`,
        "Accept": "application/vnd.github.v3+json"
      };

      try {
        const getRes = await fetch(apiUrl, { headers });
        const fileData = await getRes.json();
        const sha = fileData.sha;

        const fullHtml = `
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Custom FEIS Page</title></head>
<body bgcolor="white">
<hr size="3">
<pre style="font-family: 'Courier New', Courier, monospace; font-size: 14px; line-height: 1.2;">
${content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
</pre>
<hr size="3">
</body>
</html>`;

        const updateRes = await fetch(apiUrl, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: "Update site content via FEIS editor",
            content: btoa(unescape(encodeURIComponent(fullHtml))),
            sha,
            branch
          })
        });

        if (updateRes.ok) {
          alert("‚úÖ Updated! Visit your site:\nhttps://fleshamalgam.github.io/taxtrees/");
        } else {
          const err = await updateRes.json();
          console.error(err);
          alert("‚ùå Save failed: " + (err.message || "unknown error"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Error fetching or updating file.");
      }
    }
  </script>

</body>
</html>
